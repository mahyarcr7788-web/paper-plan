<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Plane Academy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: 'Indie Flower', cursive, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #fff;
            background-image: 
                linear-gradient(#919191 1px, transparent 1px),
                linear-gradient(90deg, #ff9ea5 1px, transparent 1px);
            background-size: 100% 30px, 40px 100%; 
            background-position: 0 20px, 40px 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .title {
            font-size: 4rem;
            color: #2c3e50;
            text-shadow: 2px 2px 0px #bdc3c7;
            margin-bottom: 20px;
            text-align: center;
        }

        .score {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 3rem;
            color: #2c3e50;
            font-weight: bold;
        }

        .btn {
            pointer-events: auto;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Indie Flower', cursive;
            cursor: pointer;
            border-radius: 5px;
            transform: rotate(-2deg);
            transition: transform 0.2s, background 0.2s;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
            margin: 5px;
        }

        .btn:hover {
            transform: rotate(0deg) scale(1.05);
            background: #34495e;
        }
        
        .btn-ai {
            background: #8e44ad;
            font-size: 1.2rem;
            padding: 10px 25px;
        }
        
        .btn-ai:hover {
            background: #9b59b6;
        }

        #game-over-screen, #start-screen {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border: 2px solid #2c3e50;
            border-radius: 10px;
            text-align: center;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1);
            transform: rotate(1deg);
            max-width: 500px;
            width: 90%;
        }

        #game-over-screen {
            display: none;
        }
        
        #excuse-display {
            margin-top: 15px;
            font-size: 1.2rem;
            color: #e74c3c;
            min-height: 1.5em;
            font-style: italic;
        }

        /* Teacher Mode UI */
        #teacher-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            pointer-events: auto;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-family: sans-serif; /* Boring font */
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.3);
        }

        #teacher-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 999;
            font-family: 'Courier New', monospace;
            padding: 50px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .fake-math {
            font-size: 1.2rem;
            color: #000;
            line-height: 1.5;
        }
        
        .homework-controls {
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        
        .btn-boring {
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 5px 10px;
            cursor: pointer;
            font-family: sans-serif;
            font-size: 0.9rem;
        }
        .btn-boring:hover {
            background: #bdc3c7;
        }

        .hidden {
            display: none !important;
        }
        
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- UI Elements -->
    <div id="ui-layer">
        <div class="score" id="scoreDisplay">0</div>

        <div id="start-screen">
            <h1 class="title">Paper Plane<br>Academy</h1>
            <p style="font-size: 1.5rem;">Click or Spacebar to Fly</p>
            <p style="font-size: 1.2rem; margin-bottom: 20px;">Avoid the pencils!</p>
            <button class="btn" onclick="startGame()">Start Class</button>
        </div>

        <div id="game-over-screen">
            <h1 class="title" style="font-size: 3rem;">Detention!</h1>
            <p style="font-size: 1.5rem;">Score: <span id="final-score">0</span></p>
            <p style="font-size: 1.2rem;" id="high-score-display">Best: 0</p>
            <br>
            <div id="excuse-display"></div>
            <button class="btn btn-ai" onclick="generateExcuse()">✨ Generate Excuse</button>
            <br><br>
            <button class="btn" onclick="resetGame()">Try Again</button>
        </div>
    </div>

    <button id="teacher-btn" onclick="toggleTeacherMode()">Teacher Mode (ESC)</button>

    <!-- Fake Spreadsheet/Math Overlay -->
    <div id="teacher-overlay">
        <div class="homework-controls">
            <h2 style="display:inline; margin-right: 20px;">Assignments</h2>
            <button class="btn-boring" onclick="generateHomework()">✨ Generate New Problem Set (AI)</button>
        </div>
        
        <h2 id="hw-title" style="border-bottom: 1px solid black; padding-bottom: 10px;">Advanced Calculus: Homework Set 4</h2>
        <div id="math-content" class="fake-math">
            <!-- Default Content -->
            <p><strong>Problem 1:</strong> Calculate the integral of f(x) = 3x^2 + 2x - 5 from x=0 to x=10.</p>
            <p style="color: blue;">Solution: &int; (3x^2 + 2x - 5) dx = [x^3 + x^2 - 5x] from 0 to 10 = (1000 + 100 - 50) - 0 = 1050.</p>
            <br>
            <p><strong>Problem 2:</strong> Determine the derivative of g(x) = e^(2x) * sin(x).</p>
            <p style="color: blue;">Solution: g'(x) = 2e^(2x)sin(x) + e^(2x)cos(x) = e^(2x)(2sin(x) + cos(x)).</p>
            <br>
            <p><strong>Problem 3:</strong> Solve for x: ln(x) + ln(x-2) = ln(3).</p>
            <p style="color: blue;">Solution: ln(x(x-2)) = ln(3) &rArr; x^2 - 2x - 3 = 0 &rArr; (x-3)(x+1) = 0. x = 3 (since x > 2).</p>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiLayer = document.getElementById('ui-layer');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreSpan = document.getElementById('final-score');
    const highScoreSpan = document.getElementById('high-score-display');
    const teacherOverlay = document.getElementById('teacher-overlay');
    const excuseDisplay = document.getElementById('excuse-display');
    const mathContent = document.getElementById('math-content');

    // API Setup
    // Use the environment variable if available, otherwise empty string for offline mode
    const apiKey = ""; 

    // --- STEALTH MODE DATA (Offline Fallbacks) ---
    const offlineExcuses = [
        "I was testing the aerodynamic properties of my homework, Professor.",
        "The gravity in here is surprisingly inconsistent today.",
        "I thought this was Aviation class? My mistake.",
        "My hand slipped... repeatedly.",
        "I was just trying to pass a note to the future.",
        "A fly landed on my desk and I had to intercept it.",
        "I'm studying projectile motion for Physics lab.",
        "It wasn't me, it was a gust of wind from the vents."
    ];

    const offlineHomework = [
        `
        <p><strong>Problem 1:</strong> Solve the differential equation dy/dx = 2xy.</p>
        <p style="color: blue;">Solution: Separating variables, dy/y = 2x dx. Integrating both sides, ln|y| = x^2 + C. Therefore, y = Ce^(x^2).</p>
        <br>
        <p><strong>Problem 2:</strong> Calculate the limit as x approaches 0 of (sin x)/x.</p>
        <p style="color: blue;">Solution: Using L'Hôpital's Rule, derivative of sin x is cos x, derivative of x is 1. cos(0)/1 = 1.</p>
        <br>
        <p><strong>Problem 3:</strong> Find the eigenvalues of matrix A = [[1, 2], [2, 1]].</p>
        <p style="color: blue;">Solution: det(A - λI) = (1-λ)^2 - 4 = 0. (1-λ)^2 = 4. 1-λ = ±2. λ = -1, 3.</p>
        `,
        `
        <p><strong>Problem 1:</strong> Determine the stoichiometry of the reaction between H2SO4 and NaOH.</p>
        <p style="color: blue;">Solution: H2SO4 + 2NaOH -> Na2SO4 + 2H2O. The molar ratio is 1:2.</p>
        <br>
        <p><strong>Problem 2:</strong> Calculate the pH of a 0.01M HCl solution.</p>
        <p style="color: blue;">Solution: HCl is a strong acid. [H+] = 0.01M = 10^-2 M. pH = -log(10^-2) = 2.</p>
        <br>
        <p><strong>Problem 3:</strong> What is the oxidation state of Cr in K2Cr2O7?</p>
        <p style="color: blue;">Solution: 2(+1) + 2(Cr) + 7(-2) = 0. 2 + 2Cr - 14 = 0. 2Cr = 12. Cr = +6.</p>
        `
    ];

    // Helper to get fallback data
    function getFallback(type) {
        if (type === 'excuse') {
            return offlineExcuses[Math.floor(Math.random() * offlineExcuses.length)];
        } else if (type === 'homework') {
            return offlineHomework[Math.floor(Math.random() * offlineHomework.length)];
        }
        return "Error 404: Creativity not found.";
    }

    async function callGemini(prompt, type) {
        // 1. Check if key is missing (Web Deployment scenario)
        if (!apiKey || apiKey.trim() === "") {
            console.log("Stealth Mode: Using offline " + type);
            return getFallback(type);
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error('API request failed');
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("AI Connection Failed, switching to backup:", error);
            // 2. Fallback if the internet is actually down or key is invalid
            return getFallback(type);
        }
    }

    async function generateExcuse() {
        excuseDisplay.innerHTML = '<span class="loading">Thinking of a good lie...</span>';
        const prompt = "Write a very short, funny, creative excuse (max 1 sentence) a student would give a teacher for why they were throwing a paper airplane in class or why they weren't paying attention. Be witty.";
        
        // Pass 'excuse' type to handle fallback
        const excuse = await callGemini(prompt, 'excuse');
        excuseDisplay.innerText = `"${excuse}"`;
    }

    async function generateHomework() {
        mathContent.innerHTML = '<p class="loading">Fetching new assignment from the database...</p>';
        const prompt = "Generate 3 complex-looking homework problems with step-by-step solutions. Can be Calculus, Physics, or Organic Chemistry. Format them using simple HTML tags like <p>, <strong>, <br>. Make them look like a serious worksheet.";
        
        // Pass 'homework' type to handle fallback
        const homework = await callGemini(prompt, 'homework');
        mathContent.innerHTML = homework;
        document.getElementById('hw-title').innerText = "Generated Worksheet #" + Math.floor(Math.random() * 1000);
    }

    // --- GAME LOGIC ---

    let animationId;
    let score = 0;
    let highScore = localStorage.getItem('paperPlaneHighScore') || 0;
    let isGameRunning = false;
    let isTeacherMode = false;
    let frames = 0;
    let gameSpeed = 3;

    // Responsive Canvas
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Game Objects
    const plane = {
        x: 100,
        y: canvas.height / 2,
        width: 40,
        height: 30,
        velocity: 0,
        gravity: 0.15, // Low gravity
        lift: -4,      // Low lift
        rotation: 0,
        
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            // Rotate based on velocity
            this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
            ctx.rotate(this.rotation);

            // Draw Paper Plane
            ctx.beginPath();
            ctx.fillStyle = '#fff';
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            
            // Main body
            ctx.moveTo(-20, -10);
            ctx.lineTo(20, 0);
            ctx.lineTo(-20, 10);
            ctx.lineTo(-15, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Center fold
            ctx.beginPath();
            ctx.moveTo(-20, 10);
            ctx.lineTo(20, 0);
            ctx.stroke();

            ctx.restore();
        },

        update() {
            this.velocity += this.gravity;
            this.y += this.velocity;

            // Floor/Ceiling collision
            if (this.y + this.height/2 >= canvas.height || this.y - this.height/2 <= 0) {
                endGame();
            }
        },

        flap() {
            this.velocity = this.lift;
        }
    };

    let obstacles = [];

    class Obstacle {
        constructor() {
            this.spacing = 200; // Gap size
            this.top = (Math.random() * (canvas.height / 2)) + 50;
            this.bottom = canvas.height - (this.top + this.spacing);
            this.x = canvas.width;
            this.width = 50;
            this.passed = false;
            this.color = '#f1c40f'; // Pencil Yellow
            this.eraserColor = '#ff9ea5'; // Eraser Pink
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;

            // Top Pencil (Pointy facing down)
            // Wood body
            ctx.fillRect(this.x, 0, this.width, this.top);
            ctx.strokeRect(this.x, 0, this.width, this.top);
            // Eraser detail
            ctx.fillStyle = '#95a5a6'; // Metal band
            ctx.fillRect(this.x, 0, this.width, 20);
            ctx.strokeRect(this.x, 0, this.width, 20);
            ctx.fillStyle = this.eraserColor; // Eraser
            ctx.fillRect(this.x, -20, this.width, 20); // Off screen mostly

            // Pencil Tip (Triangle)
            ctx.fillStyle = '#f5deb3'; // Wood
            ctx.beginPath();
            ctx.moveTo(this.x, this.top);
            ctx.lineTo(this.x + this.width, this.top);
            ctx.lineTo(this.x + this.width/2, this.top + 40);
            ctx.fill();
            ctx.stroke();
            
            // Graphite
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.moveTo(this.x + this.width/2 - 5, this.top + 32);
            ctx.lineTo(this.x + this.width/2 + 5, this.top + 32);
            ctx.lineTo(this.x + this.width/2, this.top + 40);
            ctx.fill();


            // Bottom Pencil (Pointy facing up)
            let bottomY = canvas.height - this.bottom;
            
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, bottomY, this.width, this.bottom);
            ctx.strokeRect(this.x, bottomY, this.width, this.bottom);

            // Eraser detail bottom
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(this.x, canvas.height - 20, this.width, 20);
            ctx.strokeRect(this.x, canvas.height - 20, this.width, 20);

            // Tip Bottom
            ctx.fillStyle = '#f5deb3';
            ctx.beginPath();
            ctx.moveTo(this.x, bottomY);
            ctx.lineTo(this.x + this.width, bottomY);
            ctx.lineTo(this.x + this.width/2, bottomY - 40);
            ctx.fill();
            ctx.stroke();

            // Graphite Bottom
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.moveTo(this.x + this.width/2 - 5, bottomY - 32);
            ctx.lineTo(this.x + this.width/2 + 5, bottomY - 32);
            ctx.lineTo(this.x + this.width/2, bottomY - 40);
            ctx.fill();
        }

        update() {
            this.x -= gameSpeed;

            // Collision Detection
            // Using simple AABB collision logic tailored for the gap
            
            // X overlap
            if (plane.x + 20 > this.x && plane.x - 20 < this.x + this.width) {
                // Y overlap (hitting top pencil point or bottom pencil point)
                // We add a little forgiveness (padding) to the tip
                if (plane.y - 10 < this.top + 30 || plane.y + 10 > canvas.height - this.bottom - 30) {
                    endGame();
                }
            }

            // Score update
            if (this.x + this.width < plane.x && !this.passed) {
                score++;
                scoreDisplay.innerText = score;
                this.passed = true;
                // Speed up slightly every 5 points
                if(score % 5 === 0) gameSpeed += 0.2;
            }
        }
    }

    // Input Handling
    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.code === 'ArrowUp') {
            if (isGameRunning) plane.flap();
        }
        if (e.code === 'Escape') {
            toggleTeacherMode();
        }
    });

    window.addEventListener('mousedown', (e) => {
        // Don't flap if clicking a button
        if (e.target.tagName === 'BUTTON') return;
        if (isGameRunning) plane.flap();
    });

    window.addEventListener('touchstart', (e) => {
        if (e.target.tagName === 'BUTTON') return;
        if (isGameRunning) {
            e.preventDefault(); // Prevent scrolling
            plane.flap();
        }
    });

    function toggleTeacherMode() {
        isTeacherMode = !isTeacherMode;
        if (isTeacherMode) {
            teacherOverlay.style.display = 'block';
            if (isGameRunning) cancelAnimationFrame(animationId);
        } else {
            teacherOverlay.style.display = 'none';
            if (isGameRunning) loop();
        }
    }

    function initGame() {
        plane.y = canvas.height / 2;
        plane.velocity = 0;
        obstacles = [];
        score = 0;
        gameSpeed = 3;
        frames = 0;
        scoreDisplay.innerText = score;
        excuseDisplay.innerText = ""; // Clear old excuse
    }

    function startGame() {
        initGame();
        startScreen.style.display = 'none';
        gameOverScreen.style.display = 'none';
        scoreDisplay.style.display = 'block';
        isGameRunning = true;
        loop();
    }

    function resetGame() {
        startGame();
    }

    function endGame() {
        isGameRunning = false;
        cancelAnimationFrame(animationId);
        
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('paperPlaneHighScore', highScore);
        }
        
        finalScoreSpan.innerText = score;
        highScoreSpan.innerText = "Best: " + highScore;
        scoreDisplay.style.display = 'none';
        gameOverScreen.style.display = 'block';
    }

    function loop() {
        if (!isGameRunning) return;

        // Background Clear
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Update Plane
        plane.update();
        plane.draw();

        // Manage Obstacles
        if (frames % 120 === 0) { // Add new obstacle every ~2 seconds
            obstacles.push(new Obstacle());
        }

        for (let i = 0; i < obstacles.length; i++) {
            obstacles[i].update();
            obstacles[i].draw();
            
            // Remove off-screen obstacles
            if (obstacles[i].x + obstacles[i].width < 0) {
                obstacles.splice(i, 1);
                i--;
            }
        }

        frames++;
        animationId = requestAnimationFrame(loop);
    }
</script>

</body>
</html>
